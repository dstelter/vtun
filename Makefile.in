#
#   VTun - Virtual Tunnel over TCP/IP network. 
#
#   Copyright (C) 1998-2000  Maxim Krasnyansky <max_mk@yahoo.com>
#
#   VTun has been derived from VPPP package by Maxim Krasnyansky. 
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   $Id: Makefile.in,v 1.1.1.2 2000/03/28 17:18:50 maxk Exp $
#  
CC = @CC@
CFLAGS = @CFLAGS@ @CPPFLAGS@
LDFLAGS = @LIBS@

YACC = @YACC@
YACCFLAGS = -d

LEX = @LEX@
LEXFLAGS = 

INSTALL = @INSTALL@

prefix = @prefix@
exec_prefix = @exec_prefix@

SBIN_DIR = @sbindir@
MAN_DIR  = @mandir@
ETC_DIR  = @sysconfdir@
VAR_DIR  = @localstatedir@

PID_FILE = ${VAR_DIR}/run/vtund.pid
CFG_FILE = ${ETC_DIR}/vtund.conf
STAT_DIR = ${VAR_DIR}/log/vtund
LOCK_DIR = ${VAR_DIR}/lock/vtund

DEFS = -DVTUN_CONFIG_FILE=\"$(CFG_FILE)\" -DVTUN_PID_FILE=\"$(PID_FILE)\" \
       -DVTUN_STAT_DIR=\"$(STAT_DIR)\" -DVTUN_LOCK_DIR=\"$(LOCK_DIR)\"

OBJS = main.o cfg_file.tab.o cfg_file.lex.o server.o client.o lib.o \
       llist.o auth.o tunnel.o lock.o netlib.o  \
       tun_dev.o tap_dev.o pty_dev.o pipe_dev.o \
       tcp_proto.o udp_proto.o \
       linkfd.o lfd_shaper.o lfd_zlib.o lfd_lzo.o lfd_encrypt.o 

CONFIGURE_FILES = Makefile config.status config.cache config.h config.log 

.c.o:
	$(CC) $(CFLAGS) $(DEFS) -c $<

vtund: $(OBJS)
	$(CC) $(CFLAGS) -o vtund $(OBJS) $(LFD_OBJS) $(LDFLAGS)

cfg_file.tab.o: cfg_file.y cfg_kwords.h config.h
	$(YACC) $(YACCFLAGS) -b cfg_file cfg_file.y
	$(CC) $(CFLAGS) $(DEFS) -c cfg_file.tab.c

cfg_file.lex.o: cfg_file.l cfg_kwords.h config.h
	$(LEX) $(LEXFLAGS) -ocfg_file.lex.c cfg_file.l
	$(CC) $(CFLAGS) $(DEFS) -c cfg_file.lex.c

depend:
	makedepend -- $(CFLAGS) -- *.c

clean:
	rm -f core cfg_file.tab.* cfg_file.lex.* *.o *~ *.bak vtund

distclean: clean
	rm -f $(CONFIGURE_FILES)
	./config.drivers unlink

install_man: 
	$(INSTALL) -d -m 644 -o root -g 0 $(MAN_DIR)/man8
	$(INSTALL) -m 644 -o root -g 0 vtund.8 $(MAN_DIR)/man8
	rm -f $(MAN_DIR)/man8/vtun.8 
	ln -s vtund.8 $(MAN_DIR)/man8/vtun.8 

install_config: 
	$(INSTALL) -d -m 755 -o root -g 0 $(ETC_DIR)
	if [ ! -f $(ETC_DIR)/vtund.conf ]; then \
	  $(INSTALL) -m 600 -o root -g 0 vtund.conf $(ETC_DIR); \
	fi

install: vtund install_config install_man
	$(INSTALL) -d -m 755 -o root -g 0 $(VAR_DIR)/run
	$(INSTALL) -d -m 755 -o root -g 0 $(STAT_DIR)
	$(INSTALL) -d -m 755 -o root -g 0 $(LOCK_DIR)
	$(INSTALL) -d -m 755 -o root -g 0 $(SBIN_DIR)
	$(INSTALL) -m 755 -o root -g 0 vtund $(SBIN_DIR)

# DO NOT DELETE THIS LINE -- make depend depends on it.
